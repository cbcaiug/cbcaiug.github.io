<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CBC AI Tool</title>
    <link rel="icon" type="image/jpeg" href="https://raw.githubusercontent.com/derikmusa/derikmusa.github.io/a8d098a0d2e51d472cf4291b37e02d4f26f7d642/cbc-ai-tool-logo.jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen">
    <div id="login-screen" class="flex items-center justify-center min-h-screen">
        <div class="bg-slate-800 p-8 rounded-lg shadow-2xl max-w-md w-full">
            <div class="flex justify-center mb-4">
                <img src="https://raw.githubusercontent.com/derikmusa/derikmusa.github.io/a8d098a0d2e51d472cf4291b37e02d4f26f7d642/cbc-ai-tool-logo.jpeg" alt="CBC AI Tool" class="w-20 h-20 rounded-lg">
            </div>
            <h1 class="text-2xl font-bold mb-6 text-center">üîê Admin Access</h1>
            <input 
                type="password" 
                id="admin-password" 
                placeholder="Enter admin password"
                class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                autocomplete="current-password"
            />
            <button 
                onclick="login()"
                class="w-full bg-indigo-600 hover:bg-indigo-700 p-3 rounded-lg font-semibold"
            >
                Login
            </button>
            <p id="login-error" class="text-red-400 text-sm mt-2 hidden"></p>
        </div>
    </div>

    <div id="admin-panel" class="hidden p-6 max-w-7xl mx-auto">
        <header class="mb-8 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://raw.githubusercontent.com/derikmusa/derikmusa.github.io/a8d098a0d2e51d472cf4291b37e02d4f26f7d642/cbc-ai-tool-logo.jpeg" alt="CBC AI Tool" class="w-16 h-16 rounded-lg">
                <div>
                    <h1 class="text-3xl font-bold mb-2">üéõÔ∏è Admin Dashboard</h1>
                    <p class="text-slate-400">Manage user quotas and view statistics</p>
                </div>
            </div>
            <button 
                onclick="logout()"
                class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-semibold transition-colors"
            >
                Sign Out
            </button>
        </header>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-slate-800 p-6 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Total Users</h3>
                <p id="total-users" class="text-4xl font-bold text-indigo-400">0</p>
            </div>
            <div class="bg-slate-800 p-6 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Active Today</h3>
                <p id="active-today" class="text-4xl font-bold text-green-400">-</p>
            </div>
            <div class="bg-slate-800 p-6 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Quick Actions</h3>
                <button 
                    onclick="resetAllQuotas()"
                    class="w-full bg-red-600 hover:bg-red-700 p-2 rounded-lg text-sm font-semibold"
                >
                    Reset All Quotas
                </button>
            </div>
        </div>

        <!-- Search User -->
        <div class="bg-slate-800 p-6 rounded-lg mb-8">
            <h2 class="text-xl font-bold mb-4">üîç Search User</h2>
            <div class="flex gap-4">
                <input 
                    type="email" 
                    id="search-email" 
                    placeholder="Enter user email"
                    class="flex-1 p-3 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
                <button 
                    onclick="searchUser()"
                    class="bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded-lg font-semibold"
                >
                    Search
                </button>
            </div>
            <div id="search-result" class="mt-4"></div>
            <button 
                id="clear-search-btn"
                onclick="clearSearch()"
                class="hidden mt-2 bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm"
            >
                Clear Results
            </button>
        </div>

        <!-- All Users Table -->
        <div class="bg-slate-800 p-6 rounded-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">üë• All Users</h2>
                <button 
                    onclick="loadAllUsers()"
                    class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm"
                >
                    Refresh
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="border-b border-slate-700">
                        <tr>
                            <th class="p-3">Email</th>
                            <th class="p-3">Downloads</th>
                            <th class="p-3">Messages</th>
                            <th class="p-3">Created</th>
                            <th class="p-3">Last Active</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table" class="divide-y divide-slate-700">
                        <tr>
                            <td colspan="6" class="p-4 text-center text-slate-400">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebase config (same as main app)
        const firebaseConfig = {
            apiKey: "AIzaSyCkileHkaS3AymxvNnNAA_c0peWaL8RLTI",
            authDomain: "cbcaiug-auth.firebaseapp.com",
            projectId: "cbcaiug-auth",
            storageBucket: "cbcaiug-auth.firebasestorage.app",
            messagingSenderId: "570813240478",
            appId: "1:570813240478:web:d6b177bca3e291f25ed78f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Admin credentials
        const ADMIN_EMAIL = "cbcaitool@gmail.com";
        const ADMIN_PASSWORD = "cbcaiug2025";
        let adminUser = null;
        let unsubscribe = null;

        function toEAT(timestamp) {
            if (!timestamp) return 'Never';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('en-US', { 
                timeZone: 'Africa/Nairobi',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function login() {
            const password = document.getElementById('admin-password').value;
            const error = document.getElementById('login-error');
            
            if (password !== ADMIN_PASSWORD) {
                error.textContent = 'Incorrect password';
                error.classList.remove('hidden');
                return;
            }

            // Sign in to Firebase as admin
            try {
                error.textContent = 'Signing in...';
                error.classList.remove('hidden');
                error.style.color = '#60a5fa';
                
                const userCredential = await firebase.auth().signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PASSWORD);
                adminUser = userCredential.user;
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadAllUsers();
            } catch (authError) {
                console.error('Auth error:', authError);
                error.style.color = '#ef4444';
                
                if (authError.code === 'auth/user-not-found') {
                    error.textContent = 'Admin account not created yet. Creating...';
                    try {
                        const newUser = await firebase.auth().createUserWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PASSWORD);
                        adminUser = newUser.user;
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('admin-panel').classList.remove('hidden');
                        loadAllUsers();
                    } catch (createError) {
                        error.textContent = 'Failed to create admin: ' + createError.message;
                    }
                } else {
                    error.textContent = 'Login failed: ' + authError.message;
                }
            }
        }

        async function loadAllUsers() {
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-400">Loading...</td></tr>';

            if (unsubscribe) unsubscribe();

            unsubscribe = db.collection('users').onSnapshot((snapshot) => {
                document.getElementById('total-users').textContent = snapshot.size;

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-amber-400">‚ö†Ô∏è No users yet</td></tr>';
                    document.getElementById('active-today').textContent = '0';
                    return;
                }

                // Count active today (last active within 24 hours)
                const now = Date.now();
                const oneDayAgo = now - (24 * 60 * 60 * 1000);
                let activeToday = 0;

                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const email = data.email || 'No email';
                    const created = toEAT(data.createdAt);
                    const lastActive = toEAT(data.lastActive);
                    
                    // Check if active today
                    if (data.lastActive) {
                        const lastActiveTime = data.lastActive.toDate ? data.lastActive.toDate().getTime() : new Date(data.lastActive).getTime();
                        if (lastActiveTime >= oneDayAgo) {
                            activeToday++;
                        }
                    }
                    
                    html += `
                        <tr class="hover:bg-slate-700">
                            <td class="p-3 text-sm">${email}</td>
                            <td class="p-3">
                                <span class="px-2 py-1 bg-indigo-600 rounded">${data.downloadsLeft || 0}/20</span>
                            </td>
                            <td class="p-3">
                                <span class="px-2 py-1 bg-green-600 rounded">${data.messagesLeft || 0}/50</span>
                            </td>
                            <td class="p-3 text-slate-400 text-xs">${created}</td>
                            <td class="p-3 text-slate-400 text-xs">${lastActive}</td>
                            <td class="p-3">
                                <button 
                                    onclick="resetUserQuota('${doc.id}')"
                                    class="bg-yellow-600 hover:bg-yellow-700 px-3 py-1 rounded text-sm"
                                >
                                    Reset
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('active-today').textContent = activeToday;
                tbody.innerHTML = html;
            }, (error) => {
                console.error('Error loading users:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-400">‚ùå Error: ${error.message}</td></tr>`;
            });
        }

        function clearSearch() {
            document.getElementById('search-email').value = '';
            document.getElementById('search-result').innerHTML = '';
            document.getElementById('clear-search-btn').classList.add('hidden');
        }

        async function searchUser() {
            const searchTerm = document.getElementById('search-email').value.trim();
            const resultDiv = document.getElementById('search-result');
            const clearBtn = document.getElementById('clear-search-btn');

            if (!searchTerm) {
                resultDiv.innerHTML = '<p class="text-red-400">Please enter an email</p>';
                clearBtn.classList.add('hidden');
                return;
            }

            resultDiv.innerHTML = '<p class="text-slate-400">Searching...</p>';
            clearBtn.classList.remove('hidden');

            try {
                // Try direct UID lookup first
                let found = null;
                try {
                    const doc = await db.collection('users').doc(searchTerm).get();
                    if (doc.exists) {
                        found = { id: doc.id, ...doc.data() };
                    }
                } catch (e) {
                    // Not a valid UID, search by email
                }

                // If not found by UID, search all users by email
                if (!found) {
                    const snapshot = await db.collection('users').get();
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.email && data.email.toLowerCase() === searchTerm.toLowerCase()) {
                            found = { id: doc.id, ...data };
                        }
                    });
                }

                if (found) {
                    resultDiv.innerHTML = `
                        <div class="bg-slate-700 p-4 rounded-lg">
                            <p class="mb-2"><strong>Email:</strong> ${found.email || 'No email'}</p>
                            <p class="mb-2"><strong>Downloads:</strong> ${found.downloadsLeft || 0}/20</p>
                            <p class="mb-2"><strong>Messages:</strong> ${found.messagesLeft || 0}/50</p>
                            <p class="mb-2"><strong>Created:</strong> ${toEAT(found.createdAt)}</p>
                            <p class="mb-2"><strong>Last Active:</strong> ${toEAT(found.lastActive)}</p>
                            <button 
                                onclick="resetUserQuota('${found.id}')"
                                class="mt-3 bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded font-semibold"
                            >
                                Reset Quotas
                            </button>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<p class="text-red-400">User not found</p>';
                    clearBtn.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error searching user:', error);
                resultDiv.innerHTML = '<p class="text-red-400">Error searching user</p>';
            }
        }

        async function resetUserQuota(userId) {
            if (!confirm('Reset quotas for this user to 20 downloads and 50 messages?')) return;

            try {
                await db.collection('users').doc(userId).update({
                    downloadsLeft: 20,
                    messagesLeft: 50,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('‚úÖ Quotas reset successfully!');
            } catch (error) {
                console.error('Error resetting quota:', error);
                alert('‚ùå Error resetting quota: ' + error.message);
            }
        }

        async function resetAllQuotas() {
            if (!confirm('‚ö†Ô∏è Reset quotas for ALL users? This cannot be undone!')) return;
            if (!confirm('Are you absolutely sure? This will reset ALL user quotas.')) return;

            try {
                const snapshot = await db.collection('users').get();
                const batch = db.batch();

                snapshot.forEach(doc => {
                    batch.update(doc.ref, {
                        downloadsLeft: 20,
                        messagesLeft: 50,
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                await batch.commit();
                alert(`‚úÖ Reset quotas for ${snapshot.size} users!`);
            } catch (error) {
                console.error('Error resetting all quotas:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Allow Enter key to login
        document.getElementById('admin-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // Check if already signed in
        firebase.auth().onAuthStateChanged((user) => {
            if (user && user.email === ADMIN_EMAIL) {
                adminUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadAllUsers();
            }
        });

        // Allow Enter key to search
        document.getElementById('search-email').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchUser();
        });

        function logout() {
            if (!confirm('Sign out of admin dashboard?')) return;
            
            // Sign out from Firebase
            firebase.auth().signOut();
            
            // Clear all site data
            localStorage.clear();
            sessionStorage.clear();
            
            // Reload page to show login screen
            window.location.reload();
        }
    </script>
</body>
</html>
