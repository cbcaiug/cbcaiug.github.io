# Issue Analysis

The problem is that on mobile devices, the browser is intercepting the download links and opening them in Google Docs instead of triggering actual downloads. This is a common mobile browser behavior where `<a download>` attributes are often ignored in favor of navigation.

## Root Cause

Looking at your `DocSuccessModal` component (document index 4, lines around the download buttons), the issue is:

```jsx
// Current problematic code
<a
    href={downloadUrlDocx}
    download  // ← This attribute is often ignored on mobile
    className="..."
>
```

Mobile browsers (especially Chrome on Android and Safari on iOS) often ignore the `download` attribute and instead navigate to the URL, which then opens in Google Docs.

---

# Solution: Force Download via Backend

We'll create a backend endpoint that forces the download by setting proper headers, then update the modal to use these endpoints.

---

## Step 1: Update Google Apps Script (GAS.js)

Add a new function to handle download requests with proper headers:

**File:** `GAS.js`

**Add this new function** (after the `createGoogleDocFromHtml` function, around line 350):

```javascript
/**
 * =================================================================
 * DOCUMENT DOWNLOAD HANDLER
 * =================================================================
 */

/**
 * Handles download requests by fetching the doc and returning it with
 * proper Content-Disposition headers to force download on mobile.
 * @param {string} docId - The Google Doc ID
 * @param {string} format - Either 'docx' or 'pdf'
 * @return {Blob} The document content with proper MIME type
 */
function handleDocDownload(docId, format) {
    try {
        // Validate format
        if (format !== 'docx' && format !== 'pdf') {
            throw new Error('Invalid format. Must be docx or pdf.');
        }

        // Set the export URL based on format
        const exportUrl = `https://docs.google.com/document/d/${docId}/export?format=${format}`;

        // Fetch the document
        const response = UrlFetchApp.fetch(exportUrl, {
            headers: {
                Authorization: 'Bearer ' + ScriptApp.getOAuthToken()
            }
        });

        // Get the blob
        const blob = response.getBlob();

        // Set the appropriate MIME type and filename
        const mimeType = format === 'pdf' ? 'application/pdf' : 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
        const filename = `CBC_AI_Document.${format}`;

        blob.setContentType(mimeType);
        blob.setName(filename);

        return blob;

    } catch (error) {
        console.error('Error in handleDocDownload:', error.toString());
        throw new Error('Failed to download document: ' + error.toString());
    }
}
```

**Now update the `doGet` function** to handle download requests. Find the `doGet` function (around line 35) and add this new action handler **before the final `else` block**:

```javascript
function doGet(e) {
    try {
        const action = e.parameter.action;
        let output;

        if (action === 'getAssistants') {
            // ... existing code ...
        } else if (action === 'getPrompt' && e.parameter.assistant) {
            // ... existing code ...
        } else if (action === 'getUpdates') {
            // ... existing code ...
        } else if (action === 'getTrialApiKey') {
            // ... existing code ...
        }
        // ✅ ADD THIS NEW BLOCK HERE
        else if (action === 'downloadDoc') {
            // NEW: Handle document downloads with proper headers
            const docId = e.parameter.docId;
            const format = e.parameter.format || 'docx';

            if (!docId) {
                return ContentService.createTextOutput(JSON.stringify({
                    success: false,
                    error: 'Document ID is required'
                })).setMimeType(ContentService.MimeType.JSON);
            }

            try {
                const blob = handleDocDownload(docId, format);
                // Return the file with proper download headers
                return HtmlService.createHtmlOutput()
                    .append('<script>window.close();</script>')
                    .setContent(blob.getBytes())
                    .setMimeType(blob.getContentType());
            } catch (error) {
                return ContentService.createTextOutput(JSON.stringify({
                    success: false,
                    error: error.toString()
                })).setMimeType(ContentService.MimeType.JSON);
            }
        }
        // ... rest of existing code ...
```

**Save and redeploy** your Google Apps Script as a new version.

---

## Step 2: Update DocSuccessModal Component

Now we need to update the modal to use our new backend endpoint instead of direct Google links.

**File:** `js/components/Modals.js` (or `src/components/Modals.jsx`)

**Replace the entire `DocSuccessModal` component** (around line 155) with this updated version:

```javascript
// NEW: Modal with proper mobile download support
export const DocSuccessModal = ({ isOpen, onClose, docInfo }) => {
    if (!isOpen || !docInfo) return null;

    // NEW: Use our backend endpoint for downloads with proper headers
    const downloadUrlDocx = `${GAS_WEB_APP_URL}?action=downloadDoc&docId=${docInfo.id}&format=docx`;
    const downloadUrlPdf = `${GAS_WEB_APP_URL}?action=downloadDoc&docId=${docInfo.id}&format=pdf`;

    // NEW: Handle download button clicks with explicit download behavior
    const handleDownload = (url, format) => {
        // Track the download attempt
        trackEvent('doc_download', 'DocModal', { format, docId: docInfo.id });

        // For mobile: Open in new tab with download hint
        // The backend will set proper headers to force download
        window.open(url, '_blank');
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-2xl p-6 sm:p-8 max-w-md w-full transform transition-all scale-100 opacity-100">
                <div className="text-center">
                    <CheckCircleIcon className="w-16 h-16 text-green-500 mx-auto mb-4" />
                    <h2 className="text-2xl font-bold text-slate-800">Document Created!</h2>
                    <p className="text-slate-600 mt-2">Your document is ready. You can now view it online or download it directly.</p>
                </div>

                <div className="mt-6 space-y-3">
                    {/* Button to view the document in a new tab */}
                    <a
                        href={docInfo.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="w-full flex items-center justify-center gap-3 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                    >
                        <FileTextIcon className="w-5 h-5" />
                        <span>View in Google Docs</span>
                    </a>

                    {/* UPDATED: Button to download as .docx using backend endpoint */}
                    <button
                        onClick={() => handleDownload(downloadUrlDocx, 'docx')}
                        className="w-full flex items-center justify-center gap-3 px-6 py-3 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-600 transition-colors"
                    >
                        <DownloadCloudIcon className="w-5 h-5" />
                        <span>Download as Word (.docx)</span>
                    </button>

                    {/* UPDATED: Button to download as .pdf using backend endpoint */}
                    <button
                        onClick={() => handleDownload(downloadUrlPdf, 'pdf')}
                        className="w-full flex items-center justify-center gap-3 px-6 py-3 bg-red-700 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors"
                    >
                        <DownloadCloudIcon className="w-5 h-5" />
                        <span>Download as PDF</span>
                    </button>
                </div>

                <div className="mt-6 text-center">
                    <button onClick={onClose} className="w-full sm:w-auto px-6 py-2 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    );
};
```

---

## Step 3: Import GAS_WEB_APP_URL

Make sure `GAS_WEB_APP_URL` is accessible in your Modals file.

**At the top of `js/components/Modals.js`**, add this import if it's not already there:

```javascript
// At the very top of the file, after React imports
import { GAS_WEB_APP_URL, trackEvent } from '../services/api.js';
```

Or if you're in the old structure, ensure the constant is defined:

```javascript
// If not using ES6 modules, define it directly
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxYOIr8TxQu2GV3uyTQ-vIiud5J7RnvMNheQFIHTPJPZbxIcV2LgcAhjh2VaslZPaf4/exec';
```

---

## Step 4: Testing Checklist

### On Desktop (Chrome/Firefox):
1. ✅ Generate a document using any assistant
2. ✅ Click "Save as Google Doc"
3. ✅ Modal should appear with 3 buttons
4. ✅ Click "Download as Word" → Should download a `.docx` file
5. ✅ Click "Download as PDF" → Should download a `.pdf` file
6. ✅ Open the files to confirm they're properly formatted

### On Mobile (Android Chrome/Safari iOS):
1. ✅ Generate a document using any assistant
2. ✅ Click "Save as Google Doc"
3. ✅ Modal should appear
4. ✅ Click "Download as Word" → **NEW: Should now trigger download instead of opening in Google Docs**
5. ✅ Click "Download as PDF" → **NEW: Should now trigger download instead of opening in Google Docs**
6. ✅ Check your phone's "Downloads" folder for the files

### Console Checks:
- Open browser DevTools (F12)
- Go to Console tab
- Look for any errors when clicking download buttons
- Should see tracking events: `doc_download` with format details

---

## Why This Works

1. **Backend Control**: By routing downloads through our GAS endpoint, we can set proper HTTP headers (`Content-Disposition: attachment`) that force browsers to download instead of navigate
2. **OAuth Token**: Using `ScriptApp.getOAuthToken()` ensures we have permission to export the doc
3. **Blob Handling**: Converting to blob with explicit MIME types ensures correct file format
4. **Mobile Compatibility**: Opening in `_blank` with proper headers works across iOS Safari, Android Chrome, etc.

---

## Rollback Plan

If something breaks:

```bash
# In VS Code terminal
git status  # See what changed
git checkout -- js/components/Modals.js  # Restore old modal
git checkout -- GAS.js  # Restore old backend
```

Then redeploy the old GAS version from the Google Apps Script editor.

---

## Alternative: Simple Fallback

If the backend approach doesn't work on your mobile, add this simpler fallback to the `handleDownload` function:

```javascript
const handleDownload = (url, format) => {
    trackEvent('doc_download', 'DocModal', { format, docId: docInfo.id });

    // Fallback for stubborn mobile browsers
    const link = document.createElement('a');
    link.href = url;
    link.download = `CBC_AI_Document.${format}`;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};
```

---

```
feat(mobile): fix document downloads on mobile devices

- Add backend download handler in GAS with proper Content-Disposition headers
- Update DocSuccessModal to use backend endpoint instead of direct Google links
- Replace <a download> with button + window.open for better mobile support
- Add trackEvent calls for download analytics
- Ensure MIME types and filenames are properly set for both docx and pdf formats

Files changed: GAS.js, js/components/Modals.js
```
