CBC AI Tool - Commit Log
========================

[2025-01-23 04:00 EAT] feat(auth): add OAuth and OTP verification to auth modal

CHANGES:
- js/auth/supabase-auth.js: complete auth modal redesign
- Added Google OAuth button with official branding
- Added OTP verification screen with 6-digit input
- Disabled Facebook/Twitter OAuth (too complex to configure)
- Removed username support (email only)
- Added auto-focus and keyboard navigation for OTP inputs
- Added resend OTP functionality
- Better error handling and user feedback

FEATURES:
- ✅ Google OAuth (one-click sign in)
- ✅ Email/Password authentication
- ✅ OTP email verification (6-digit code)
- ✅ Resend OTP code
- ✅ Professional UI with proper icons
- ✅ Mobile-responsive design

REMOVED:
- ❌ Username-only accounts (@local.app)
- ❌ Facebook OAuth (disabled)
- ❌ Twitter OAuth (disabled)

NEXT STEPS:
- Update Supabase email template (remove links, OTP only)
- Update Site URL in Supabase settings
- Test OTP verification flow
- Disable Facebook/Twitter in Supabase dashboard

---

[2025-01-23 03:25 EAT] security: remove exposed API keys from repository

CRITICAL SECURITY FIX:
- ai-suite-assets/myAPIkeys.txt: REMOVED from repository (contained 6 exposed API keys)
- .gitignore: added myAPIkeys.txt to prevent future commits
- SECURITY_INCIDENT.md: created incident report with mitigation steps
- GAS_DEPLOYMENT_INSTRUCTIONS.md: created deployment guide

INCIDENT:
- 6 Google AI Studio keys were committed to public GitHub repo
- Keys were auto-deleted by Google's security scanner or reported
- All keys have been regenerated and stored securely in GAS Script Properties

MITIGATION:
- File removed from git tracking and deleted
- Added to .gitignore
- New keys created and stored in GAS Script Properties (secure)
- Keys still exist in GitHub history (optional: use BFG to remove)

PREVENTION:
- Never commit API keys to version control
- Use GAS Script Properties for secure storage
- Use .gitignore for sensitive files
- Store personal keys in password manager or Google Drive private folder

---

[2025-01-23 03:15 EAT] fix(quota): add real-time sync and fix model selection

CHANGES:
- js/auth/supabase-auth.js: added subscribeToQuotaUpdates() for real-time sync
- js/components/App.js: added real-time quota listener to update counts across devices
- js/components/App.js: fixed onModelChange to accept both event and direct model name

FIXES:
1. Real-time quota sync across devices (phone/PC updates immediately)
2. Model selection now works with shared API keys (can select any Gemini model)
3. Browser counts update automatically when other device consumes quota

BEFORE:
- Browser required reload to see quota changes from other devices
- Model selection stuck on gemini-2.5-pro with shared keys
- Sidebar passed model name but App.js expected event object

AFTER:
- Supabase real-time subscription updates browser counts instantly
- Users can select any Gemini model while using shared keys
- Model selection works from both dropdown and direct calls

NOTE: Shared API keys not working is a backend (GAS) issue, not frontend.
Recommendation: Check GAS script for key rotation logic and add fresh keys.

---

[2025-01-23 02:45 EAT] fix(quota): fix state sync and copy integration with Supabase

CHANGES:
- js/components/App.js: fixed copy button to consume Supabase quota
- js/components/App.js: fixed generation tracking to update browser state immediately
- js/components/App.js: fixed initializeApp to load Supabase quotas FIRST before local fallback
- js/components/App.js: removed forced model reset when enabling shared API keys

FIXES:
1. Copy button now properly consumes Supabase download quota and syncs state
2. Generation count now updates in browser immediately after completion (no reload needed)
3. Logout/login now shows correct Supabase counts immediately (no more showing 50/20)
4. Users can now switch between any Gemini model while using shared API keys
5. State sync uses Promise chains instead of async IIFE for reliable React updates

BEFORE:
- Copy only decremented local state, not Supabase
- Generation count required page reload to update
- Logout/login showed max counts (50/20) until reload
- Shared API key forced model to gemini-2.5-pro
- Async tracking in detached context caused state update issues

AFTER:
- Copy and Save both consume same Supabase quota (free_downloads_remaining)
- Generation count updates immediately in browser
- Logout/login shows correct Supabase counts instantly
- Users can select any Gemini model with shared keys
- State updates happen in main execution context via Promise chains

TESTING RESULTS:
✅ Copy reduces both browser and Supabase counts
✅ Save reduces both browser and Supabase counts
✅ Generations update browser count immediately
✅ Logout/login persists correct counts from Supabase
✅ Model switching works with shared API keys
✅ Private tabs show same counts (Supabase persistence)
✅ Browser clear preserves counts (Supabase persistence)

---

[2025-01-XX XX:XX] feat(auth): add Supabase username/email authentication

CHANGES:
- js/auth/supabase-auth.js: minimal auth module with username or email support
- js/components/App.js: integrated consent modal trigger for new users
- js/components/Sidebar.js: display active username/email with sign out button
- app.html: integrated Supabase auth script

FEATURES:
- Users sign up with username (auto-appends @local.app) or email + password
- No email confirmation required (disabled in Supabase dashboard)
- Consent modal shows after first sign up/sign in for terms acceptance
- Session persists across assistants and page reloads
- Active account shown in sidebar (username without @local.app suffix)
- Sign Out button clears Supabase session
- Auth state listener updates username immediately after sign in

DATABASE:
- Supabase table: usage_quotas (user_id, free_generations_remaining: 50, free_downloads_remaining: 20, accepted_terms)
- RPC functions: consume_generation(), consume_download()
- Row Level Security (RLS) policies enabled

CONFIGURATION NEEDED:
1. Supabase dashboard → Authentication → Providers → Email → Confirm email: OFF
2. Supabase dashboard → Authentication → URL Configuration:
   - Site URL: https://cbcaiug.github.io/cbcaiug.github.io/app.html
3. Run SQL in Supabase SQL Editor (see directions.txt for full SQL)

REMOVED:
- auth-confirm.html (email confirmation handler - no longer needed)
- OTP/token verification code
- Email countdown timers
- Resend code functionality

NEXT STEPS:
- Integrate Supabase quota tracking with existing GAS system (see SUPABASE_INTEGRATION_PLAN.md)
- Send generation/download events to both Supabase and GAS for redundancy
- Test: Clear browser data → quotas persist
- Test: Private tabs → same quota counts
- Add OAuth providers (Google, Microsoft, Facebook) - optional

---
COMMIT MESSAGE:

feat(auth): add Supabase authentication with username/email

- Add minimal auth system without email confirmation
- Integrate consent modal for new users
- Display active user in sidebar with sign out
- Session persists across page reloads
- Remove unused email verification code
- RPC functions ready for quota integration (see SUPABASE_INTEGRATION_PLAN.md)
